<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自動交易控制台</title>
    <!-- Cache bust: bump version when files change -->
    <link rel="stylesheet" href="/static/css/dashboard.css?v=5">
</head>
<body>
    <div class="container">
        <h1>📊 自動交易控制台</h1>
        
        <div class="auth-section">
            <label for="authKey">API 驗證金鑰</label>
            <input type="password" id="authKey" placeholder="請輸入驗證金鑰">
            <label class="simulation-toggle">
                <input type="checkbox" id="simulationMode" checked>
                <span>模擬模式</span>
            </label>
            <button class="btn-primary" onclick="loadCurrentTab()">載入資料</button>
            <button class="btn-secondary" onclick="exportCSV()">匯出 CSV</button>
        </div>
        
        <div class="error-msg" id="errorMsg"></div>
        
        <div class="tabs">
            <button class="tab" onclick="switchTab('trading')">🚀 快速下單</button>
            <button class="tab active" onclick="switchTab('orders')">📋 委託紀錄</button>
            <button class="tab" onclick="switchTab('positions')">💼 目前持倉</button>
            <button class="tab" onclick="switchTab('account')">💰 帳戶資訊</button>
            <button class="tab" onclick="switchTab('symbols')">📜 可用商品</button>
            <button class="tab" onclick="switchTab('limits')">📊 API 限制</button>
            <button class="tab" onclick="switchTab('webhook')">🔗 TradingView 設定</button>
        </div>
        
        <!-- Trading Tab (NEW) -->
        <div id="trading-tab" class="tab-content">
            <div class="trading-panel">
                <!-- Left: Order Panel -->
                <div class="order-panel">
                    <div class="panel-header">
                        <h2>🚀 快速下單</h2>
                        <div class="trading-mode-badge" id="tradingModeBadge">
                            <span class="mode-dot simulation"></span>
                            <span id="tradingModeText">模擬模式</span>
                        </div>
                    </div>
                    
                    <!-- Symbol Selector -->
                    <div class="form-group">
                        <label>商品選擇</label>
                        <div class="symbol-selector">
                            <select id="tradingSymbol" onchange="onSymbolChange()">
                                <option value="">-- 選擇商品 --</option>
                                <optgroup label="微型台指 (TMF)">
                                    <option value="TMFR1">TMFR1 - 微台近月</option>
                                </optgroup>
                                <optgroup label="小台指 (MXF)">
                                    <option value="MXFR1">MXFR1 - 小台近月</option>
                                </optgroup>
                                <optgroup label="大台指 (TXF)">
                                    <option value="TXFR1">TXFR1 - 大台近月</option>
                                </optgroup>
                            </select>
                            <button class="btn-icon" onclick="refreshSymbols()" title="重新載入商品">🔄</button>
                        </div>
                    </div>
                    
                    <!-- Quote Display -->
                    <div class="quote-display" id="quoteDisplay">
                        <div class="quote-price">
                            <span class="price-label">現價</span>
                            <span class="price-value" id="currentPrice">--</span>
                        </div>
                        <div class="quote-info">
                            <div class="quote-item">
                                <span class="label">漲停</span>
                                <span class="value up" id="limitUp">--</span>
                            </div>
                            <div class="quote-item">
                                <span class="label">跌停</span>
                                <span class="value down" id="limitDown">--</span>
                            </div>
                            <div class="quote-item">
                                <span class="label">參考</span>
                                <span class="value" id="refPrice">--</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quantity -->
                    <div class="form-group">
                        <label>委託口數</label>
                        <div class="quantity-input">
                            <button class="qty-btn" onclick="adjustQty(-1)">−</button>
                            <input type="number" id="orderQuantity" value="1" min="1" max="100">
                            <button class="qty-btn" onclick="adjustQty(1)">+</button>
                        </div>
                        <div class="qty-presets">
                            <button onclick="setQty(1)">1</button>
                            <button onclick="setQty(2)">2</button>
                            <button onclick="setQty(5)">5</button>
                            <button onclick="setQty(10)">10</button>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        <button class="btn-long" onclick="placeOrder('long_entry')" id="btnLongEntry">
                            <span class="btn-icon">📈</span>
                            <span class="btn-text">做多</span>
                            <span class="btn-sub">買進開倉</span>
                        </button>
                        <button class="btn-short" onclick="placeOrder('short_entry')" id="btnShortEntry">
                            <span class="btn-icon">📉</span>
                            <span class="btn-text">做空</span>
                            <span class="btn-sub">賣出開倉</span>
                        </button>
                    </div>
                    
                    <!-- Close Position Buttons -->
                    <div class="close-buttons">
                        <button class="btn-close-long" onclick="placeOrder('long_exit')">
                            <span>📤 平多</span>
                        </button>
                        <button class="btn-close-short" onclick="placeOrder('short_exit')">
                            <span>📥 平空</span>
                        </button>
                        <button class="btn-close-all" onclick="closeAllPositions()">
                            <span>⚡ 全部平倉</span>
                        </button>
                    </div>
                    
                    <!-- Order Status -->
                    <div class="order-status" id="orderStatus" style="display: none;">
                        <div class="status-icon" id="statusIcon">⏳</div>
                        <div class="status-text" id="statusText">處理中...</div>
                    </div>
                </div>
                
                <!-- Right: Position & Info Panel -->
                <div class="info-panel">
                    <!-- Current Position -->
                    <div class="position-card">
                        <div class="card-header">
                            <h3>💼 目前持倉</h3>
                            <button class="btn-refresh" onclick="refreshPositions()">🔄</button>
                        </div>
                        <div class="position-content" id="currentPositionDisplay">
                            <div class="no-position">無持倉</div>
                        </div>
                    </div>
                    
                    <!-- Account Summary -->
                    <div class="account-card">
                        <div class="card-header">
                            <h3>💰 帳戶摘要</h3>
                        </div>
                        <div class="account-content">
                            <div class="account-row">
                                <span class="label">可用保證金</span>
                                <span class="value" id="tradingMargin">--</span>
                            </div>
                            <div class="account-row">
                                <span class="label">未實現損益</span>
                                <span class="value" id="tradingPnl">--</span>
                            </div>
                            <div class="account-row">
                                <span class="label">風險指標</span>
                                <span class="value" id="tradingRisk">--</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Orders -->
                    <div class="recent-orders-card">
                        <div class="card-header">
                            <h3>📋 最近委託</h3>
                        </div>
                        <div class="recent-orders" id="recentOrdersList">
                            <div class="no-orders">尚無委託</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Orders Tab -->
        <div id="orders-tab" class="tab-content active">
            <div class="filters">
                <select id="filterStatus">
                    <option value="">全部狀態</option>
                    <option value="success">成功</option>
                    <option value="failed">失敗</option>
                    <option value="no_action">無動作</option>
                </select>
                <select id="filterAction">
                    <option value="">全部動作</option>
                    <option value="long_entry">做多進場</option>
                    <option value="long_exit">做多出場</option>
                    <option value="short_entry">做空進場</option>
                    <option value="short_exit">做空出場</option>
                </select>
                <input type="text" id="filterSymbol" placeholder="商品代碼...">
                <button class="btn-secondary" onclick="fetchOrders()">套用篩選</button>
            </div>
            
            <div class="stats" id="orderStats">
                <div class="stat-card total"><h3>總委託數</h3><div class="value" id="statTotal">-</div></div>
                <div class="stat-card success"><h3>成功</h3><div class="value" id="statSuccess">-</div></div>
                <div class="stat-card failed"><h3>失敗</h3><div class="value" id="statFailed">-</div></div>
            </div>
            
            <div id="ordersTable"><div class="empty">請輸入驗證金鑰並點擊「載入資料」查看委託紀錄</div></div>
        </div>
        
        <!-- Positions Tab -->
        <div id="positions-tab" class="tab-content">
            <div class="stats" id="positionStats">
                <div class="stat-card total"><h3>持倉數量</h3><div class="value" id="posCount">-</div></div>
                <div class="stat-card" id="pnlCard"><h3>未實現損益</h3><div class="value" id="totalPnl">-</div></div>
            </div>
            
            <div id="positionsTable"><div class="empty">請輸入驗證金鑰並點擊「載入資料」查看目前持倉</div></div>
        </div>
        
        <!-- Account Tab (NEW) -->
        <div id="account-tab" class="tab-content">
            <div class="info-card">
                <h2>💰 帳戶資訊</h2>
                <p style="color: #a1a1aa; margin-top: 0.5rem;">查看保證金、損益、成交紀錄和結算資料</p>
                <div class="alert alert-info" style="margin-top: 1rem;">
                    💡 <strong>提示：</strong>
                    <ul style="margin: 0.5rem 0 0 1.5rem; line-height: 1.8;">
                        <li>模擬帳戶預設只有<strong>查詢權限</strong>（Portfolio, Data）</li>
                        <li>如需下單功能，請向永豐金證券申請<strong>交易權限</strong></li>
                        <li>目前可查詢：持倉、保證金、損益等資訊</li>
                        <li>成交紀錄需要有實際交易後才會顯示</li>
                    </ul>
                </div>
            </div>
            
            <!-- Margin & P&L Stats -->
            <div class="stats" id="accountStats">
                <div class="stat-card"><h3>帳戶餘額</h3><div class="value" id="accountBalance">-</div></div>
                <div class="stat-card"><h3>可用保證金</h3><div class="value" id="availableMargin">-</div></div>
                <div class="stat-card" id="realizedPnlCard"><h3>已實現損益</h3><div class="value" id="realizedPnl">-</div></div>
                <div class="stat-card" id="unrealizedPnlCard"><h3>未實現損益</h3><div class="value" id="unrealizedPnl">-</div></div>
            </div>
            
            <!-- Sub Tabs -->
            <div class="sub-tabs">
                <button class="sub-tab active" onclick="switchAccountTab('trades')">📊 成交紀錄</button>
                <button class="sub-tab" onclick="switchAccountTab('settlements')">📅 結算資料</button>
            </div>
            
            <!-- Trades Sub-Tab -->
            <div id="trades-subtab" class="sub-tab-content active">
                <h3 style="margin: 1rem 0 0.5rem; color: #00d9ff;">成交紀錄</h3>
                <div id="tradesTable"><div class="empty">點擊「載入資料」查看成交紀錄</div></div>
            </div>
            
            <!-- Settlements Sub-Tab -->
            <div id="settlements-subtab" class="sub-tab-content">
                <h3 style="margin: 1rem 0 0.5rem; color: #00d9ff;">結算資料</h3>
                <div id="settlementsTable"><div class="empty">點擊「載入資料」查看結算資料</div></div>
            </div>
        </div>
        
        <!-- Symbols Tab -->
        <div id="symbols-tab" class="tab-content">
            <div class="info-card">
                <h2>📜 可用交易商品</h2>
                <p style="color: #a1a1aa; margin-top: 0.5rem;">以下為目前可交易的期貨商品。<strong style="color: #00d9ff;">請使用 Symbol 欄位</strong>設定 TradingView 警報。</p>
                <div class="alert alert-info" style="margin-top: 1rem;">
                    💡 <strong>Symbol</strong> (如 MXF202601) 是 Shioaji API 使用的格式；<strong>Code</strong> (如 MXFA6) 是交易所代碼，僅供參考。
                </div>
            </div>
            
            <div class="filters">
                <input type="text" id="symbolSearch" placeholder="搜尋商品代碼..." oninput="filterSymbols()">
                <button class="btn-primary" onclick="fetchSymbols()">重新載入</button>
            </div>
            
            <div class="stats" id="symbolStats">
                <div class="stat-card total"><h3>商品總數</h3><div class="value" id="symbolCount">-</div></div>
            </div>
            
            <div id="symbolsTable"><div class="empty">點擊「重新載入」取得商品列表</div></div>
        </div>
        
        <!-- API Limits Tab -->
        <div id="limits-tab" class="tab-content">
            <div class="info-card">
                <h2>📊 API 使用量監控</h2>
                <p style="color: #a1a1aa; margin-top: 0.5rem;">即時查看 Shioaji API 的使用量與限制狀態</p>
            </div>
            
            <!-- Real-time Usage Stats -->
            <div class="usage-header">
                <h3>📡 即時使用量</h3>
                <button class="btn-primary" onclick="fetchUsage()">🔄 重新整理</button>
            </div>
            
            <div class="usage-grid" id="usageStats">
                <!-- 連線數 -->
                <div class="usage-card">
                    <div class="usage-icon">🔗</div>
                    <div class="usage-info">
                        <div class="usage-label">連線數</div>
                        <div class="usage-value">
                            <span id="usageConnections">-</span>
                            <span class="usage-limit">/ 5</span>
                        </div>
                        <div class="usage-bar">
                            <div class="usage-bar-fill" id="connectionsBar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                
                <!-- 流量使用 -->
                <div class="usage-card wide">
                    <div class="usage-icon">📦</div>
                    <div class="usage-info">
                        <div class="usage-label">今日流量</div>
                        <div class="usage-value">
                            <span id="usageBytes">-</span>
                            <span class="usage-limit">/ <span id="usageLimitBytes">-</span></span>
                        </div>
                        <div class="usage-bar">
                            <div class="usage-bar-fill" id="bytesBar" style="width: 0%"></div>
                        </div>
                        <div class="usage-detail">
                            剩餘: <span id="usageRemainingBytes">-</span> (<span id="usageRemainingPercent">-</span>%)
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Limits Reference -->
            <div class="info-card" style="margin-top: 1.5rem;">
                <h3>📋 API 限制參考</h3>
            </div>
            
            <div class="limits-grid">
                <!-- 帳務查詢 -->
                <div class="limit-card">
                    <div class="limit-header">
                        <span class="limit-icon">💰</span>
                        <h3>帳務查詢</h3>
                    </div>
                    <div class="limit-value">
                        <span class="number">25</span>
                        <span class="unit">次 / 5秒</span>
                    </div>
                    <div class="limit-apis">
                        <div class="api-tag">list_profit_loss_detail</div>
                        <div class="api-tag">account_balance</div>
                        <div class="api-tag">list_settlements</div>
                        <div class="api-tag">list_profit_loss</div>
                        <div class="api-tag">list_positions</div>
                        <div class="api-tag">margin</div>
                    </div>
                    <div class="limit-note">以上查詢總次數 5 秒上限 25 次</div>
                </div>
                
                <!-- 委託操作 -->
                <div class="limit-card">
                    <div class="limit-header">
                        <span class="limit-icon">📝</span>
                        <h3>委託操作</h3>
                    </div>
                    <div class="limit-value">
                        <span class="number">250</span>
                        <span class="unit">次 / 10秒</span>
                    </div>
                    <div class="limit-apis">
                        <div class="api-tag">place_order</div>
                        <div class="api-tag">update_status</div>
                        <div class="api-tag">update_qty</div>
                        <div class="api-tag">update_price</div>
                        <div class="api-tag">cancel_order</div>
                    </div>
                    <div class="limit-note">以上查詢總次數 10 秒上限 250 次</div>
                </div>
                
                <!-- 訂閱數 -->
                <div class="limit-card">
                    <div class="limit-header">
                        <span class="limit-icon">📡</span>
                        <h3>訂閱數</h3>
                    </div>
                    <div class="limit-value">
                        <span class="number">200</span>
                        <span class="unit">個</span>
                    </div>
                    <div class="limit-apis">
                        <div class="api-tag">api.subscribe()</div>
                    </div>
                    <div class="limit-note">即時行情訂閱數量上限 200 個</div>
                </div>
                
                <!-- 連線數 -->
                <div class="limit-card">
                    <div class="limit-header">
                        <span class="limit-icon">🔗</span>
                        <h3>連線數</h3>
                    </div>
                    <div class="limit-value">
                        <span class="number">5</span>
                        <span class="unit">個連線</span>
                    </div>
                    <div class="limit-apis">
                        <div class="api-tag">api.login()</div>
                    </div>
                    <div class="limit-note">同一永豐金證券 person_id，僅可使用最多 5 個連線<br>⚠️ 注意: api.login() 即建立一個連線</div>
                </div>
                
                <!-- 登入次數 -->
                <div class="limit-card">
                    <div class="limit-header">
                        <span class="limit-icon">🔐</span>
                        <h3>登入次數</h3>
                    </div>
                    <div class="limit-value">
                        <span class="number">1000</span>
                        <span class="unit">次 / 天</span>
                    </div>
                    <div class="limit-apis">
                        <div class="api-tag">api.login()</div>
                    </div>
                    <div class="limit-note">每日登入次數上限 1000 次</div>
                </div>
                
                <!-- 行情查詢 -->
                <div class="limit-card">
                    <div class="limit-header">
                        <span class="limit-icon">📈</span>
                        <h3>行情查詢</h3>
                    </div>
                    <div class="limit-value">
                        <span class="number">50</span>
                        <span class="unit">次 / 5秒</span>
                    </div>
                    <div class="limit-apis">
                        <div class="api-tag">ticks</div>
                        <div class="api-tag">kbars</div>
                        <div class="api-tag">snapshots</div>
                    </div>
                    <div class="limit-note">歷史行情查詢 5 秒上限 50 次</div>
                </div>
            </div>
            
            <!-- 流量限制 -->
            <div class="info-card" style="margin-top: 1.5rem;">
                <h3>📦 每日流量限制</h3>
                <p style="color: #a1a1aa; margin: 0.5rem 0 1rem;">依據近 30 日成交金額決定每日流量上限</p>
                <table class="limits-table">
                    <thead>
                        <tr>
                            <th>近 30 日成交金額</th>
                            <th>每日流量限制</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>0 元</td>
                            <td><strong style="color: #ffc107;">500 MB</strong></td>
                        </tr>
                        <tr>
                            <td>1 元 ~ 1 億元</td>
                            <td><strong style="color: #00d9ff;">2 GB</strong></td>
                        </tr>
                        <tr>
                            <td>> 1 億元</td>
                            <td><strong style="color: #00ff88;">10 GB</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- 注意事項 -->
            <div class="info-card" style="margin-top: 1.5rem;">
                <h3>⚠️ 重要注意事項</h3>
                <div class="alert alert-warning" style="margin-top: 1rem;">
                    <ul style="margin: 0; padding-left: 1.5rem; line-height: 2;">
                        <li>流量超過限制時，行情查詢將回傳空值</li>
                        <li>使用量超過限制將<strong>暫停服務一分鐘</strong></li>
                        <li>不使用時請呼叫 <code>api.logout()</code> 釋放連線</li>
                        <li>連線閒置約 5 分鐘後會自動斷線</li>
                        <li>可使用 <code>api.usage()</code> 查詢目前使用量</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Webhook Tab -->
        <div id="webhook-tab" class="tab-content">
            <div class="info-card">
                <h2>🔗 TradingView Webhook 設定指南</h2>
                <p style="color: #a1a1aa; margin-top: 0.5rem;">此後端系統專為 TradingView 警報 Webhook 設計，可自動執行期貨交易。</p>
            </div>
            
            <div class="info-card" id="webhookCard">
                <h3>📍 步驟一：Webhook 網址</h3>
                <p style="color: #a1a1aa; margin: 0.5rem 0;">將以下網址貼到 TradingView 警報的 Webhook URL 欄位：</p>
                
                <!-- Mode Toggle Switch -->
                <div style="display: flex; align-items: center; gap: 1rem; margin: 1rem 0;">
                    <span id="simLabel" style="color: #22c55e; font-weight: 600;">🧪 模擬模式</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="modeToggle" onchange="toggleTradingMode()">
                        <span class="toggle-slider"></span>
                    </label>
                    <span id="realLabel" style="color: #71717a;">💰 實盤模式</span>
                </div>
                
                <div class="code-block" id="webhookCodeBlock">
                    <button class="copy-btn" onclick="copyWebhookUrl()">複製</button>
                    <pre id="webhookUrl"></pre>
                </div>
                
                <!-- Real Trading Warning (hidden by default) -->
                <div class="alert" id="realTradingWarning" style="display: none; margin-top: 1rem; background: rgba(220, 38, 38, 0.15); border: 1px solid rgba(220, 38, 38, 0.4); color: #fca5a5;">
                    ⚠️ <strong>實盤模式</strong> — 此網址將執行真實交易，請確認已設定 CA 憑證。
                </div>
                
                <!-- Simulation Mode Info -->
                <div class="alert alert-info" id="simModeInfo" style="margin-top: 1rem;">
                    ✅ <strong>模擬模式：</strong>安全測試環境，不會執行真實交易。
                </div>
            </div>
            
            <div class="info-card">
                <h3>📝 步驟二：訊息格式 (Message)</h3>
                <p style="color: #a1a1aa; margin: 0.5rem 0;">在 TradingView 警報的「訊息」欄位中，使用以下 JSON 格式（搭配 Pine Script 策略）：</p>
                <div class="code-block">
                    <button class="copy-btn" onclick="copyToClipboard(this, document.getElementById('payloadTemplate').textContent)">複製</button>
                    <pre id="payloadTemplate">{
    "action": "{{strategy.order.alert_message}}",
    "quantity": {{strategy.order.contracts}},
    "symbol": "MXFR1"
}</pre>
                </div>
                <div class="alert alert-info">
                    💡 <strong>說明：</strong><code>{{strategy.order.alert_message}}</code> 會自動帶入 Pine Script 中設定的 alert_message 值
                </div>
            </div>
            
            <div class="info-card">
                <h3>📜 步驟三：Pine Script 策略範例</h3>
                <p style="color: #a1a1aa; margin: 0.5rem 0;">在您的 Pine Script 策略中，使用 <code>alert_message</code> 參數設定交易動作：</p>
                <div class="code-block">
                    <button class="copy-btn" onclick="copyToClipboard(this, document.getElementById('pinescriptExample').textContent)">複製</button>
                    <pre id="pinescriptExample">//@version=5
strategy("My Strategy", overlay=true, default_qty_type=strategy.fixed, default_qty_value=1)

// ===== 參數設定 =====
stopLossPct = input.float(2.0, "止損 %", minval=0.1, step=0.1)
takeProfitPct = input.float(4.0, "止盈 %", minval=0.1, step=0.1)

// ===== 進場條件 =====
fastMA = ta.sma(close, 14)
slowMA = ta.sma(close, 28)
longCondition = ta.crossover(fastMA, slowMA)
shortCondition = ta.crossunder(fastMA, slowMA)

// ===== 止損止盈價格計算 =====
longStopLoss = strategy.position_avg_price * (1 - stopLossPct / 100)
longTakeProfit = strategy.position_avg_price * (1 + takeProfitPct / 100)
shortStopLoss = strategy.position_avg_price * (1 + stopLossPct / 100)
shortTakeProfit = strategy.position_avg_price * (1 - takeProfitPct / 100)

// ===== 做多進場（同時平空倉） =====
if (longCondition)
    if (strategy.position_size < 0)  // 有空單先平倉
        strategy.close("Short", alert_message="short_exit")
    strategy.entry("Long", strategy.long, alert_message="long_entry")

// ===== 做空進場（同時平多倉） =====
if (shortCondition)
    if (strategy.position_size > 0)  // 有多單先平倉
        strategy.close("Long", alert_message="long_exit")
    strategy.entry("Short", strategy.short, alert_message="short_entry")

// ===== 多單止損止盈 =====
if (strategy.position_size > 0)
    strategy.exit("Long Exit", "Long", stop=longStopLoss, limit=longTakeProfit, alert_message="long_exit")

// ===== 空單止損止盈 =====
if (strategy.position_size < 0)
    strategy.exit("Short Exit", "Short", stop=shortStopLoss, limit=shortTakeProfit, alert_message="short_exit")</pre>
                </div>
            </div>
            
            <div class="info-card">
                <h3>📋 欄位說明</h3>
                <div class="field-list">
                    <div class="field-item">
                        <span class="field-name">action</span>
                        <span class="field-desc">交易動作（使用 <code>{{strategy.order.alert_message}}</code> 自動帶入）</span>
                        <span class="badge badge-required">必填</span>
                    </div>
                    <div class="field-item">
                        <span class="field-name">quantity</span>
                        <span class="field-desc">交易口數（可用 <code>{{strategy.order.contracts}}</code> 或固定數字）</span>
                        <span class="badge badge-required">必填</span>
                    </div>
                    <div class="field-item">
                        <span class="field-name">symbol</span>
                        <span class="field-desc">商品代碼（如 <code>MXFR1</code>、<code>MXF202601</code>）— 請使用「可用商品」頁面的 Symbol 欄位值</span>
                        <span class="badge badge-required">必填</span>
                    </div>
                </div>
                
                <h3 style="margin-top: 1.5rem;">🎯 action 可用值</h3>
                <div class="action-grid">
                    <div class="action-item">
                        <span class="action action-long_entry">long_entry</span>
                        <span class="action-desc">做多進場 - 買入開倉</span>
                    </div>
                    <div class="action-item">
                        <span class="action action-long_exit">long_exit</span>
                        <span class="action-desc">做多出場 - 賣出平倉</span>
                    </div>
                    <div class="action-item">
                        <span class="action action-short_entry">short_entry</span>
                        <span class="action-desc">做空進場 - 賣出開倉</span>
                    </div>
                    <div class="action-item">
                        <span class="action action-short_exit">short_exit</span>
                        <span class="action-desc">做空出場 - 買入平倉</span>
                    </div>
                </div>
            </div>
            
            <div class="info-card">
                <h3>🔄 TradingView 可用佔位符</h3>
                <p style="color: #a1a1aa; margin: 0.5rem 0 1rem;">以下是 TradingView 警報中可使用的變數：</p>
                <div class="var-list">
                    <div class="var-item">
                        <code>{{strategy.order.alert_message}}</code>
                        <span class="var-desc">Pine Script 中 alert_message 參數的值</span>
                    </div>
                    <div class="var-item">
                        <code>{{strategy.order.contracts}}</code>
                        <span class="var-desc">委託的合約數量</span>
                    </div>
                    <div class="var-item">
                        <code>{{strategy.order.action}}</code>
                        <span class="var-desc">委託動作（buy/sell）</span>
                    </div>
                    <div class="var-item">
                        <code>{{strategy.order.price}}</code>
                        <span class="var-desc">委託價格</span>
                    </div>
                    <div class="var-item">
                        <code>{{strategy.position_size}}</code>
                        <span class="var-desc">目前持倉大小</span>
                    </div>
                    <div class="var-item">
                        <code>{{ticker}}</code>
                        <span class="var-desc">商品代碼</span>
                    </div>
                    <div class="var-item">
                        <code>{{time}}</code>
                        <span class="var-desc">警報觸發時間</span>
                    </div>
                </div>
            </div>
            
            <div class="info-card">
                <h3>📌 警報訊息範例</h3>
                
                <h4 style="color: #00d9ff; margin: 1rem 0 0.5rem;">✨ 推薦：搭配 Pine Script 策略使用</h4>
                <p style="color: #a1a1aa; margin: 0.5rem 0;">action 由策略自動帶入，quantity 使用策略設定的口數：</p>
                <div class="code-block">
                    <button class="copy-btn" onclick="copyToClipboard(this, this.nextElementSibling.textContent)">複製</button>
                    <pre>{"action": "{{strategy.order.alert_message}}", "quantity": {{strategy.order.contracts}}, "symbol": "MXFR1"}</pre>
                </div>
                
                <h4 style="color: #a1a1aa; margin: 1.5rem 0 0.5rem;">📝 手動設定：固定值</h4>
                <p style="color: #a1a1aa; margin: 0.5rem 0;">適用於簡單警報或指標觸發：</p>
                <div class="example-grid">
                    <div class="example-card">
                        <h4>🟢 小台做多進場 1 口</h4>
                        <div class="code-block">
                            <button class="copy-btn" onclick="copyToClipboard(this, this.nextElementSibling.textContent)">複製</button>
                            <pre>{"action": "long_entry", "quantity": 1, "symbol": "MXFR1"}</pre>
                        </div>
                    </div>
                    <div class="example-card">
                        <h4>🔵 小台做多出場</h4>
                        <div class="code-block">
                            <button class="copy-btn" onclick="copyToClipboard(this, this.nextElementSibling.textContent)">複製</button>
                            <pre>{"action": "long_exit", "quantity": 1, "symbol": "MXFR1"}</pre>
                        </div>
                    </div>
                    <div class="example-card">
                        <h4>🔴 大台做空進場 2 口</h4>
                        <div class="code-block">
                            <button class="copy-btn" onclick="copyToClipboard(this, this.nextElementSibling.textContent)">複製</button>
                            <pre>{"action": "short_entry", "quantity": 2, "symbol": "TXFR1"}</pre>
                        </div>
                    </div>
                    <div class="example-card">
                        <h4>🟡 大台做空出場</h4>
                        <div class="code-block">
                            <button class="copy-btn" onclick="copyToClipboard(this, this.nextElementSibling.textContent)">複製</button>
                            <pre>{"action": "short_exit", "quantity": 2, "symbol": "TXFR1"}</pre>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="info-card">
                <h3>⚠️ 注意事項</h3>
                <div class="alert alert-warning">
                    <ul style="margin: 0; padding-left: 1.5rem; line-height: 1.8;">
                        <li>預設為<strong>模擬模式</strong>，如需實盤交易請在網址加上 <code>?simulation=false</code></li>
                        <li>商品代碼請使用正確的期貨代碼（可在「委託紀錄」查看歷史使用的代碼）</li>
                        <li>確保 JSON 格式正確，欄位名稱需使用<strong>雙引號</strong></li>
                        <li>quantity 必須為正整數</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Cache bust: bump version when files change -->
    <script src="/static/js/dashboard.js?v=5"></script>
</body>
</html>
